# Version 0.1

## Event flow

Any analytics specification needs a solid & reliable event flow, it is crucial that the following events are implemented correctly for the backend to reliably be able to churn out good session data.


### JSON Schema

```json
{
  sessionId: "UID",
  events: [{
    type: "event enum",
    sessionId: "",
    timestamp: 1634911668339, // UTC time. The client SHOULD send valid UTC time.

    playhead: 0, // The current playhead position in milliseconds. -1 if unknown
    duration: 0, // The duration of the content in milliseconds. VOD = length of stream, Live no DVR = -1, Live with seekable range = live edge in UTC. -1 if unknown 
    payload?: {
      // Unique to each event
      // If needed additional custom fields may be added here as well but the server MAY ignore them. 
    }
  }]
}
```

See the full [schema](schema/0.1.schema.json)

### init

This is the first event that needs to be sent, this should be sent just before the player starts loading the contentUrl.

```json
{
  event: "init",
  sessionId?: "" // if not provided the server MUST generate it
  timestamp: -1,
  playhead: -1,
  duration: -1,
  payload: {
    contentId: "",
    contentUrl: "",
    userId?: "", 
    deviceId?: ""
    deviceModel?: ""
    deviceType?: ""
    ... // additional parameters can be added as needed, however the server may choose to ignore them.
  }
}
```

The `init` event is the only event that actually receives a JSON response from the server
```json
{
  sessionId: ''
  heartbeatInterval: 30, 
}
```

After the init response the client MUST send the heartbeat event at the provided interval, until the session has ended.

### heartbeat

This is sent at a fixed interval using the provided value from the `init` event response.

```json
{
  event: "heartbeat",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0,
}
```
 
### loading

This is sent when the contentUrl has been attached to the client player.

```json
{
  event: "loading",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0
}
```


### loaded

This is sent when it's possible for the player to play the contentUrl. 

```json
{
  event: "loaded",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0
}
```

### play

This is sent as soon as player request that playback starts, eg. when the user presses play or when autoplay kicks in.

```json
{
  event: "play",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0
}
```


### playing

This is sent when playback starts, when the playhead starts to move.

```json
{
  event: "playing",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0
}
```


### pause

This is sent when the player is paused, should not be sent when buffering/seeking.

```json
{
  event: "pause",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0
}
```

### resume

This is sent when the player resume playback after a pause.

```json
{
  event: "heartbeat",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0
}
```

### buffering

This is sent when the player starts buffering, should not be sent when seeking or loading.

```json
{
  event: "heartbeat",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0
}
```

### buffered

This is sent when the player resumes playback after buffering. If buffering is interrupted for any reason this MUST be sent with the payload `interrupted: true` 

```json
{
  event: "buffered",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0
  payload: {
    interrupted?: boolean
  }
}
```

### seeking

This is sent when the player starts seeking to a new playhead time. `playhead` MUST be the current playhead time NOT the target playhead time.

```json
{
  event: "heartbeat",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0
}
```

### seeked

This is sent when the player starts seeking to a new playhead time. `playhead` MUST be new playhead time.

```json
{
  event: "heartbeat",
  sessionId: "",
  timestamp: 0,
  playhead: 0,
  duration: 0
}
```

### bitrate_changed

This is sent when the player switches between different ABR levels.

```json
{
  event: "bitrate_changed",
  payload: {
    bitrate: "", // bitrate in Kbps
    width?: "", // video width in pixels
    height?: "", // video height in pixels
    videoBitrate?: "", // if available provide the birate for the video track
    audioBitrate?: "", // if availalbe provide the birate for the audio track
  }
}
```

### stopped

This is sent when playback stops for whatever reason.

```json
{
  event: "stopped",
  payload: {
    reason?: "" // eg. "ended", "aborted", "error"
  }
}
```

### error

This is sent when a fatal error occurs, if the player does not recover from this error the `stopped` event SHOULD be sent with `reason: "error"`.

```json
{
  event: "error",
  payload: {
    category?: "", // eg. NETWORK, DECODER, osv.
    code: "",
    message?: "", 
    data?: {} 
  }
}
```

### warn

This is sent when a non-fatal error occurs, eg. a subtitle track doesn't work but the player is still able to play the content.

```json
{
  event: "warn",
  payload: {
    category?: "", // eg. NETWORK, DECODER, osv.
    code "",
    message?: "",
    data?: {} 
  }
}
```
